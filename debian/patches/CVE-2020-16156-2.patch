From bcbf6d608e48d25306ecfd273118b4d6ba1c5df6 Mon Sep 17 00:00:00 2001
From: Andreas Koenig <andk@cpan.org>
Date: Sun, 21 Nov 2021 16:59:43 +0100
Subject: [PATCH] Add two new failure modes based on cpan_path

---
 lib/CPAN/Distribution.pm                      |   24 +
 .../authors/id/B/BU/BUSTER/CHECKSUMS          |    6 +
 t/CPAN/authors/id/A/AN/ANDK/CHECKSUMS         |  836 ++++++--------
 t/CPAN/authors/id/A/AN/ANDK/CHECKSUMS.2nd     | 1019 +++++++++++------
 4 files changed, 1046 insertions(+), 839 deletions(-)

Index: perl-5.30.0/cpan/CPAN/lib/CPAN/Distribution.pm
===================================================================
--- perl-5.30.0.orig/cpan/CPAN/lib/CPAN/Distribution.pm
+++ perl-5.30.0/cpan/CPAN/lib/CPAN/Distribution.pm
@@ -1534,6 +1534,30 @@ for further processing, but got garbage
         $answer =~ /^\s*y/i or $CPAN::Frontend->mydie("Aborted.\n");
         $self->{CHECKSUM_STATUS} = "NIL -- CHECKSUMS file broken";
         return;
+    } elsif (exists $cksum->{$basename} && ! exists $cksum->{$basename}{cpan_path}) {
+        $CPAN::Frontend->mywarn(qq{
+Warning: checksum file '$chk_file' not conforming.
+
+The cksum does not contain the key 'cpan_path' for '$basename'.
+});
+        my $answer = CPAN::Shell::colorable_makemaker_prompt("Proceed nonetheless?", "no");
+        $answer =~ /^\s*y/i or $CPAN::Frontend->mydie("Aborted.\n");
+        $self->{CHECKSUM_STATUS} = "NIL -- CHECKSUMS file without cpan_path";
+        return;
+    } elsif (exists $cksum->{$basename} && substr($self->{ID},0,length($cksum->{$basename}{cpan_path}))
+             ne $cksum->{$basename}{cpan_path}) {
+        $CPAN::Frontend->mywarn(qq{
+Warning: checksum file not matching path '$self->{ID}'.
+
+The cksum contain the key 'cpan_path=$cksum->{$basename}{cpan_path}'
+which does not match the ID of the distribution '$self->{ID}'.
+Something's suspicious might be going on here. Please investigate.
+
+});
+        my $answer = CPAN::Shell::colorable_makemaker_prompt("Proceed nonetheless?", "no");
+        $answer =~ /^\s*y/i or $CPAN::Frontend->mydie("Aborted.\n");
+        $self->{CHECKSUM_STATUS} = "NIL -- CHECKSUMS non-matching cpan_path vs. ID";
+        return;
     } elsif (exists $cksum->{$basename}{sha256}) {
         $self->debug("Found checksum for $basename:" .
                      "$cksum->{$basename}{sha256}\n") if $CPAN::DEBUG;
